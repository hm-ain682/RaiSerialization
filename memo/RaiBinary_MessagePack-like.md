# RaiBinary - RAI バイナリファイル形式

## 概要
- データを永続化するバイナリファイルの形式
- MessagePackのようにスキーマの事前定義が必要ない
- 形式はMessagePackに近い

## 目標
- protobufよりファイルサイズが小さい
- protobufより読み書きが早い
- JSONと相互変換できる

## ファイル内のレイアウト
- "RAIB"の各文字(0x52 41 49 42)を1ビット左シフトしたもの(0xA4 82 92 84)
- オブジェクト
※内容はバイト単位で切れ目がある

## 書式
ビット列|型|xの意味
--|--|--
00xx xxxx|非負整数|値(0～63)
1111 xxxx|負の整数|値(-16～-1)
0100 0000|null|
0100 0001|(不使用)|
0100 0010|false|
0100 0011|true|
0100 0100|8ビット符号なし整数
0100 0101|16ビット符号なし整数
0100 0110|32ビット符号なし整数
0100 0111|64ビット符号なし整数
0100 1000|8ビット符号付き整数
0100 1001|16ビット符号付き整数
0100 1010|32ビット符号付き整数
0100 1011|64ビット符号付き整数
0100 110x|(不使用)|
0100 1110|単精度浮動小数点数
0100 1111|倍精度浮動小数点数
100x xxxx|文字列|長さ(0～31)
1010 xxxx|配列|要素数(0～15)
1011 xxxx|オブジェクト・新規フィールド定義|フィールド数(0～15)
1100 xxxx|オブジェクト・既存フィールド定義|オブジェクト定義ID(0～15)
1101 00xx|文字列|後続の長さのバイト数※
1101 01xx|配列|後続の要素数のバイト数※
1101 10xx|バイト列|後続の長さのバイト数※
1110 00xx|オブジェクト・新規フィールド定義|後続のフィールド数のサイズ※
1110 01xx|オブジェクト・既存フィールド定義|後続のオブジェクト定義IDのサイズ※
1110 1xxx|(不使用)|
1111 xxxx|(不使用)|

※00=8bit, 01=16bit, 10=32bit, 11=64bit

## 文字列のレイアウト

### 埋め込み文字数
ビット列|意味
--|--
100x xxxx|文字列開始・x=文字数N
**** ****|文字1
**** ****|…
**** ****|文字N

### 独立文字数
ビット列|意味
--|--
1101 00xx|文字列開始・x=文字数のサイズ(以下は16ビットの例)
yyyy yyyy|文字数1
yyyy yyyy|文字数2
**** ****|文字1
**** ****|…
**** ****|文字N

## 配列のレイアウト

### 埋め込み要素数
ビット列|意味
--|--
1010 xxxx|配列開始・x=N
**** ****|要素1
**** ****|…
**** ****|要素N

### 独立要素数
ビット列|意味
--|--
1101 01xx|配列開始・x=要素数のサイズ(以下は16ビットの例)
yyyy yyyy|要素数1
yyyy yyyy|要素数2
**** ****|要素1
**** ****|…
**** ****|要素N

## オブジェクト

### 新規フィールド定義・埋め込みフィールド数
ビット列|意味
--|--
1011 xxxx|オブジェクト開始・x=フィールド数N
**** ****|フィールド1のキー
**** ****|…
**** ****|フィールドNのキー
**** ****|フィールド1の値
**** ****|…
**** ****|フィールドNの値

### 新規フィールド定義・独立フィールド数
ビット列|意味
--|--
1110 00xx|オブジェクト開始・x=フィールド数のサイズ(以下は16ビットの例)
yyyy yyyy|フィールド数1
yyyy yyyy|フィールド数2
**** ****|フィールド1のキー
**** ****|…
**** ****|フィールドNのキー
**** ****|フィールド1の値
**** ****|…
**** ****|フィールドNの値

### 既存フィールド定義・埋め込みフィールド数
ビット列|意味
--|--
1100 xxxx|オブジェクト開始・x=オブジェクト定義ID
**** ****|フィールド1の値
**** ****|…
**** ****|フィールドNの値

フィールド数Nや各フィールドのキーは定義を参照する。

### 既存フィールド定義・独立フィールド数
ビット列|意味
--|--
1110 01xx|オブジェクト開始・x=オブジェクト定義IDのサイズ(以下は16ビットの例)
yyyy yyyy|オブジェクト定義ID1
yyyy yyyy|オブジェクト定義ID2
**** ****|フィールド1の値
**** ****|…
**** ****|フィールドNの値

フィールド数Nや各フィールドのキーは定義を参照する。

## JSONとの相互運用
- JSONとの相互運用時、バイナリ列の値はBASE64で文字列に変換される。
- JSONとの相互運用時、整数を符号なしかありか明らかにするため、ここでは符号の有無の情報が必要。

## その他
- 将来対応検討：半精度・4倍精度浮動小数点数
- 将来対応検討：任意長整数
- 将来対応検討：文字列テーブル（上記文字列の代わりに、テーブルにある文字列を参照する）
- FP4やFP6には対応しない；アプリ側でバイト列を変換する
