# # RaiBinary - RAI バイナリファイル形式

## 概要
- データを永続化するバイナリファイルの形式
- MessagePackのようにスキーマの事前定義が必要ない
- マルチスレッドやSIMDでの並列処理がしやすい

## 目標
- protobufより読み書きが早い
- JSONと相互変換できる

## ファイル内のレイアウト
- "RAIF"の各文字(0x52 41 49 46)を1ビット左シフトしたもの(0xA4 82 92 8C)
- オブジェクト集合テーブルの開始位置
- オブジェクト集合1
- …
- オブジェクト集合N
- オブジェクト集合テーブル
※内容はバイト単位で切れ目がある
開始位置はファイル先頭からのバイト数。

## オブジェクト集合テーブル
最初のオブジェクト集合の最初のオブジェクトがルートオブジェクト。
バイト数|項目
--|--
4|オブジェクト集合の個数N
8|オブジェクト集合1の開始位置
…|…
8|オブジェクト集合Nの開始位置

## オブジェクト集合
同じ定義に従うオブジェクトの集合。ここの各オブジェクトはフィールドのキーの組が基本的に同じ。
バイト数|項目
--|--
4|オブジェクト集合のID
4|フィールド数
4|オブジェクト数
*|フィールド1
…|…
1|フィールドN

## フィールド
バイト数|項目
--|--
1|フィールド値の型
*|キーの長さ
*|キー
1|skipMap1-8；オブジェクト1～8の当該フィールドを省略する：ビット1
*|オブジェクト1のフィールド値（skipMapで対応ビットが0のもののみ；以下同）
*|…
*|オブジェクト8のフィールド値
1|skipMap9-16
*|オブジェクト9のフィールド値
*|…
*|オブジェクト16のフィールド値
*|…

## オブジェクト参照
バイト数|項目|意味
--|--|--
*|オブジェクト定義ID|オブジェクトのフィールド構成の定義を特定する連番
*|オブジェクトID|同じオブジェクト定義の中で対象オブジェクトを特定する連番

## 単一要素型配列
バイト数|項目
--|--
1|要素型
*|オブジェクト参照（要素型がオブジェクトの場合のみ）
*|要素数
*|要素1の値
…|…
*|要素Nの値

## 任意要素型配列
バイト数|項目
--|--
4|要素数
1|要素1の型
*|要素1の値
…|…
1|要素Nの型
*|要素Nの値

## 値
型|レイアウト
--|--
オブジェクト|オブジェクト参照
数値|数値
文字列|長さ→内容

## 型
ビット列|型|x,yの意味
--|--|--
xx00 0000|真偽
xx00 0001|単精度浮動小数点数
xx00 0010|倍精度浮動小数点数
xx00 0100|8ビット符号なし整数
xx00 0101|16ビット符号なし整数
xx00 0110|32ビット符号なし整数
xx00 0111|64ビット符号なし整数
xx00 1000|8ビット符号付き整数
xx00 1001|16ビット符号付き整数
xx00 1010|32ビット符号付き整数
xx00 1011|64ビット符号付き整数
xx01 00yy|文字列|長さのサイズ
xx01 01yy|単一要素型配列|y=要素数のサイズ
xx01 10yy|任意要素型配列|y=要素数のサイズ
xx10 yyzz|オブジェクト；値はオブジェクト参照|y=オブジェクト定義IDのサイズ、z=オブジェクトIDのサイズ

xx=フィールドのキーの長さのサイズ；00=8bit, 01=16bit, 10=32bit, 11=64bit／配列要素では00
